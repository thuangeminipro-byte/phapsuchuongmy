<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Megaads Cloud Tool v50</title>
    <style>
        :root { --primary: #00f2fe; --secondary: #4facfe; --accent-ot: #fa709a; --accent-ot-end: #fee140; --success: #43e97b; --danger: #ff5858; --text: #e0e6ed; --text-muted: #8ba0b6; --border: rgba(255,255,255,0.15); --glass: rgba(255, 255, 255, 0.05); }
        body { margin: 0; padding: 25px; font-family: 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: var(--text); display: grid; grid-template-columns: 360px 1fr; gap: 25px; height: 100vh; box-sizing: border-box; overflow: hidden; }
        .sidebar, .main-content { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .card { background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid var(--border); backdrop-filter: blur(20px); position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 20px 20px 0 0; }
        h2 { margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; color: var(--primary); letter-spacing: 2px; font-weight: 800; }
        
        /* Cải thiện Dropdown và Input */
        select, input { 
            width: 100%; padding: 14px; background: rgba(0,0,0,0.6); border: 1px solid var(--border); 
            color: var(--primary); border-radius: 12px; font-size: 13px; margin-bottom: 12px; 
            outline: none; transition: 0.3s; cursor: pointer; color-scheme: dark;
        }
        select:hover, input:hover { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 242, 254, 0.2); }
        select option { background: #1e1b4b; color: #fff; padding: 10px; }

        /* Cải thiện nút bấm và khoảng cách */
        .btn-group { display: flex; gap: 15px; margin-top: 5px; } /* Thêm khoảng cách giữa 2 nút */
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 11px; 
            color: white; text-transform: uppercase; letter-spacing: 1px;
        }
        button:active { transform: scale(0.95); }
        .btn-office { background: linear-gradient(90deg, #4facfe, #00f2fe); box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3); }
        .btn-ot { background: linear-gradient(90deg, #fa709a, #fee140); box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3); }
        
        /* Badge màu sắc */
        .badge-office { background: rgba(0, 242, 254, 0.15); color: var(--primary); border: 1px solid var(--primary); padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .badge-ot { background: linear-gradient(90deg, var(--accent-ot), var(--accent-ot-end)); color: white; padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: bold; }
        
        .btn-del-item { background: linear-gradient(45deg, #ff5858, #f857a6); border: none; padding: 8px 18px; border-radius: 10px; cursor: pointer; color: #fff; font-weight: bold; }
        #logs { background: rgba(0,0,0,0.4); color: var(--success); font-family: 'Consolas', monospace; padding: 15px; border-radius: 15px; flex: 1; overflow-y: auto; font-size: 12px; border: 1px solid var(--border); }
        #clock { float: right; font-size: 20px; color: var(--primary); font-family: 'Orbitron', monospace; text-shadow: 0 0 10px var(--primary); }
        
        .table-container { overflow-y: auto; max-height: 280px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 15px; text-align: left; background: rgba(0,0,0,0.5); color: var(--text-muted); font-size: 11px; text-transform: uppercase; position: sticky; top: 0; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card">
            <h2>LỰA CHỌN NHÂN VIÊN</h2>
            <select id="staffSelect"></select>
            <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 8px; font-weight:bold;">ĐỊA ĐIỂM HỢP LỆ</label>
            <select id="locSelect"></select>
            <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; border: 1px dashed var(--border); font-family: monospace; font-size: 12px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span>IP:</span> <span id="lblIP" style="color:var(--primary); font-weight:bold;">...</span></div>
                <div style="display:flex; justify-content:space-between;"><span>THIẾT BỊ:</span> <span id="lblDevice" style="color:var(--primary); font-weight:bold;">...</span></div>
            </div>
        </div>
        <div class="card">
            <h2>CHẤM CÔNG THỦ CÔNG</h2>
            <div class="btn-group"> <button onclick="manual('HÀNH CHÍNH')" class="btn-office">HÀNH CHÍNH</button>
                <button onclick="manual('OT')" class="btn-ot">TĂNG CA (OT)</button>
            </div>
        </div>
        <div class="card">
            <h2>DỮ LIỆU CLOUD</h2>
            <div id="syncStat" style="font-size: 11px; margin-bottom: 12px; color:var(--text-muted);">Đang kết nối GitHub...</div>
            <button onclick="fetchCloudData()" style="background: rgba(255,255,255,0.08); border: 1px solid var(--border);">LÀM MỚI DỮ LIỆU</button>
        </div>
    </div>
    <div class="main-content">
        <div class="card" style="max-height:55%; display:flex; flex-direction:column;">
            <h2>HẸN GIỜ CHẤM CÔNG <span id="clock">00:00:00</span></h2>
            <div style="display:flex; gap:12px; align-items:flex-end; background:rgba(0,0,0,0.4); padding:15px; border-radius:15px;">
                <div style="flex:1;"><label style="font-size:10px; margin-bottom:5px;">GIỜ HẸN</label><input type="datetime-local" id="sTime"></div>
                <div style="flex:0.6;"><label style="font-size:10px; margin-bottom:5px;">LOẠI</label><select id="sType"><option value="HÀNH CHÍNH">HÀNH CHÍNH</option><option value="OT">OT</option></select></div>
                <div style="flex:1;"><label style="font-size:10px; margin-bottom:5px;">NHÂN VIÊN</label><select id="sStaff"></select></div>
                <div style="flex:1.2;"><label style="font-size:10px; margin-bottom:5px;">ĐỊA ĐIỂM</label><select id="sLoc"></select></div>
                <button onclick="addSched()" style="flex:0.8; background:linear-gradient(90deg, #8E2DE2, #4A00E0); height:48px; box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);">THÊM LỊCH</button>
            </div>
            <div class="table-container">
                <table><thead><tr><th>THỜI GIAN</th><th>LOẠI</th><th>NHÂN VIÊN</th><th>ĐỊA ĐIỂM</th><th>TRẠNG THÁI</th><th></th></tr></thead><tbody id="schedBody"></tbody></table>
            </div>
        </div>
        <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <h2>NHẬT KÝ HỆ THỐNG</h2>
            <div id="logs">> Hệ thống sẵn sàng!</div>
        </div>
    </div>

    <script>
        const API_OFFICE = "https://hrm-api.megaads.vn/api/staff/send-finger-print";
        const API_OT = "https://hrm-api.megaads.vn/api/staff/time-keeping/overtime";
        const DATA_URL = "https://raw.githubusercontent.com/thuangeminipro-byte/phapsuchuongmy/refs/heads/main/data.json";

        let staffs = [], locs = [], scheds = JSON.parse(localStorage.getItem('schedules')) || [];

        async function fetchCloudData() {
            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                const data = await res.json();
                staffs = data.staffs; locs = data.locs;
                renderStaffs(); updateLocs(); updateSchedLocs();
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--success);">● Cloud Sync: ${new Date().toLocaleTimeString()}</span>`;
                log("Đã cập nhật dữ liệu từ Server.");
            } catch (e) { 
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--danger);">● Lỗi đồng bộ</span>`;
                log("Lỗi: Không tải được data.json.", "#ff5858"); 
            }
        }

        window.onload = () => {
            fetchCloudData(); renderSched(); startClock();
            document.getElementById('staffSelect').onchange = updateLocs;
            document.getElementById('sStaff').onchange = updateSchedLocs;
            document.getElementById('locSelect').onchange = updateInfo;
        };

        function renderStaffs() {
            const h = staffs.map((s, i) => `<option value="${i}">${s.name} (#${s.id})</option>`).join('');
            document.getElementById('staffSelect').innerHTML = h;
            document.getElementById('sStaff').innerHTML = h;
        }

        function updateLocs() {
            const s = staffs[document.getElementById('staffSelect').value]; if(!s) return;
            document.getElementById('locSelect').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join('');
            updateInfo();
        }

        function updateSchedLocs() {
            const s = staffs[document.getElementById('sStaff').value]; if(!s) return;
            document.getElementById('sLoc').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join('');
        }

        function updateInfo() {
            const s = staffs[document.getElementById('staffSelect').value];
            if(s) { document.getElementById('lblIP').innerText = s.ip; document.getElementById('lblDevice').innerText = s.device; }
        }

        function addSched() {
            const t = document.getElementById('sTime').value; if(!t) return alert("Vui lòng chọn ngày giờ!");
            const sS = document.getElementById('sStaff'), lS = document.getElementById('sLoc');
            scheds.push({ id: Date.now(), time: t, type: document.getElementById('sType').value, sIdx: sS.value, sName: sS.options[sS.selectedIndex].text, lIdx: lS.value, lName: lS.options[lS.selectedIndex].text, exec: false, st: "ĐANG ĐỢI" });
            localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched();
            log(`Đã lên lịch cho ${sS.options[sS.selectedIndex].text}`);
        }

        function renderSched() {
            const b = document.getElementById('schedBody'); b.innerHTML = '';
            scheds.sort((a,b) => new Date(a.time) - new Date(b.time)).forEach(s => {
                const tr = document.createElement('tr'); if(s.exec) tr.style.opacity = "0.4";
                const badge = s.type == 'OT' ? 'badge-ot' : 'badge-office';
                tr.innerHTML = `<td>${new Date(s.time).toLocaleString('vi-VN')}</td><td><span class="${badge}">${s.type}</span></td><td>${s.sName}</td><td>${s.lName}</td><td style="font-weight:bold; color:var(--primary);">${s.st}</td><td style="text-align:right"><button class="btn-del-item" onclick="delS(${s.id})">XÓA</button></td>`;
                b.appendChild(tr);
            });
        }

        window.delS = (id) => { if(confirm("Xóa lịch này?")) { scheds = scheds.filter(x => x.id != id); localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }};

        function startClock() {
            setInterval(() => {
                const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN');
                scheds.forEach(s => {
                    if(!s.exec) {
                        const diff = now - new Date(s.time);
                        if(diff >= 0 && diff < 60000) {
                            trigger(s.type, staffs[s.sIdx], locs[s.lIdx]); s.exec = true; s.st = "HOÀN TẤT";
                            localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched();
                        } else if (diff >= 60000) { s.exec = true; s.st = "BỎ QUA"; localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }
                    }
                });
            }, 2000);
        }

        async function trigger(type, st, lc) {
            log(`Đang thực thi [${type}] cho ${st.name}...`);
            try {
                const res = await fetch(type == 'OT' ? API_OT : API_OFFICE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ staff_id: st.id, location_data: { lat: lc.lat, long: lc.lng, ip: st.ip, location_name: lc.name } }) });
                const d = await res.json(); log(`[Xong] ${d.message || 'Thành công'}`);
            } catch (e) { log("Lỗi: Kiểm tra CORS!", "#ff5858"); }
        }

        function manual(t) { trigger(t, staffs[document.getElementById('staffSelect').value], locs[document.getElementById('locSelect').value]); }
        function log(m, c = "var(--success)") { const d = document.createElement('div'); d.style.color = (c=="var(--success)" ? "var(--success)" : c); d.innerText = `> ${new Date().toLocaleTimeString()} ${m}`; document.getElementById('logs').prepend(d); }
    </script>
</body>
</html>
