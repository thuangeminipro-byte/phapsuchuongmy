<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megaads Cloud Tool v49 - Fixed Align</title>
    <style>
        :root { --primary: #00f2fe; --secondary: #4facfe; --accent-ot: #fa709a; --accent-ot-end: #fee140; --success: #43e97b; --danger: #ff5858; --text: #e0e6ed; --text-muted: #8ba0b6; --border: rgba(255,255,255,0.15); }
        
        body { 
            margin: 0; padding: 20px; font-family: 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); 
            color: var(--text); display: grid; grid-template-columns: 360px 1fr; gap: 25px; 
            height: 100vh; box-sizing: border-box; overflow: hidden; 
        }

        /* Tối ưu Mobile */
        @media (max-width: 900px) {
            body { grid-template-columns: 1fr; overflow-y: auto; height: auto; padding: 10px; }
            .sidebar, .main-content { overflow-y: visible; height: auto; }
            .card { margin-bottom: 15px; }
            .sched-controls { flex-direction: column !important; align-items: stretch !important; gap: 15px !important; }
            .btn-row { gap: 15px !important; }
        }

        .sidebar, .main-content { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .main-content { overflow: hidden; }
        
        .card { 
            background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 15px; 
            border: 1px solid var(--border); backdrop-filter: blur(15px); 
            position: relative; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 15px 15px 0 0; }
        
        h2 { margin: 0 0 15px 0; font-size: 13px; text-transform: uppercase; color: var(--primary); letter-spacing: 1px; }
        label { font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 5px; font-weight: 600; }
        
        /* Đồng bộ chiều cao và margin cho Desktop */
        select, input { width: 100%; padding: 12px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: #fff; border-radius: 8px; font-size: 13px; margin-bottom: 0; color-scheme: dark; box-sizing: border-box; height: 44px; }
        
        /* Khung chứa input riêng ở sidebar để có khoảng cách dưới */
        .sidebar select, .sidebar input { margin-bottom: 12px; }

        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 11px; color: white; text-transform: uppercase; height: 44px; }
        button:active { transform: scale(0.98); }

        .btn-row { display: flex; gap: 20px; } 
        .btn-office { background: linear-gradient(90deg, var(--secondary), var(--primary)); }
        .btn-ot { background: linear-gradient(90deg, var(--accent-ot), var(--accent-ot-end)); }
        
        .badge-office { background: rgba(0, 242, 254, 0.2); color: var(--primary); border: 1px solid var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        .badge-ot { background: linear-gradient(90deg, var(--accent-ot), var(--accent-ot-end)); color: white; padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        
        .btn-del-item { background: linear-gradient(90deg, #ff5858, #f857a6) !important; color: white !important; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-weight: bold; width: auto; height: 32px; }
        
        #logs { background: rgba(0,0,0,0.5); color: var(--success); font-family: monospace; padding: 15px; border-radius: 10px; flex: 1; overflow-y: auto; font-size: 12px; border: 1px solid var(--border); min-height: 150px; }
        #clock { float: right; font-size: 18px; color: var(--primary); font-family: monospace; font-weight: bold; }
        
        .table-container { overflow-x: auto; max-height: 250px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: rgba(0,0,0,0.4); position: sticky; top: 0; color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card">
            <h2>LỰA CHỌN NHÂN VIÊN</h2>
            <select id="staffSelect"></select>
            <label>ĐỊA ĐIỂM HỢP LỆ</label>
            <select id="locSelect"></select>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; border: 1px dashed var(--border); font-family: monospace; font-size: 11px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span>IP:</span> <span id="lblIP" style="color:var(--primary);">...</span></div>
                <div style="display:flex; justify-content:space-between;"><span>DEVICE:</span> <span id="lblDevice" style="color:var(--primary);">...</span></div>
            </div>
        </div>
        <div class="card">
            <h2>CHẤM CÔNG THỦ CÔNG</h2>
            <div class="btn-row">
                <button onclick="manual('HÀNH CHÍNH')" class="btn-office">HÀNH CHÍNH</button>
                <button onclick="manual('OT')" class="btn-ot">TĂNG CA (OT)</button>
            </div>
        </div>
        <div class="card">
            <h2>ĐỒNG BỘ DỮ LIỆU</h2>
            <div id="syncStat" style="font-size: 11px; margin-bottom: 10px;">Đang tải từ GitHub...</div>
            <button onclick="fetchCloudData()" style="background: rgba(255,255,255,0.1); height: 44px;">LÀM MỚI DỮ LIỆU</button>
        </div>
    </div>
    <div class="main-content">
        <div class="card" style="max-height:50%; display:flex; flex-direction:column;">
            <h2>HẸN GIỜ CHẤM CÔNG <span id="clock">00:00:00</span></h2>
            <div class="sched-controls" style="display:flex; gap:12px; align-items:flex-end; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px;">
                <div style="flex:1;"><label>THỜI GIAN</label><input type="datetime-local" id="sTime"></div>
                <div style="flex:0.6;"><label>LOẠI</label><select id="sType"><option value="HÀNH CHÍNH">HÀNH CHÍNH</option><option value="OT">OT</option></select></div>
                <div style="flex:1;"><label>NHÂN VIÊN</label><select id="sStaff"></select></div>
                <div style="flex:1.2;"><label>ĐỊA ĐIỂM</label><select id="sLoc"></select></div>
                <button onclick="addSched()" style="flex:0.8; background:linear-gradient(90deg, #8E2DE2, #4A00E0); height:44px;">THÊM LỊCH</button>
            </div>
            <div class="table-container">
                <table><thead><tr><th>GIỜ HẸN</th><th>LOẠI</th><th>TÊN</th><th>ĐỊA ĐIỂM</th><th>TRẠNG THÁI</th><th></th></tr></thead><tbody id="schedBody"></tbody></table>
            </div>
        </div>
        <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <h2>NHẬT KÝ HỆ THỐNG (TERMINAL)</h2>
            <div id="logs">> Megaads Cloud v49 Fixed Align.</div>
        </div>
    </div>

    <script>
        const API_OFFICE = "https://hrm-api.megaads.vn/api/staff/send-finger-print";
        const API_OT = "https://hrm-api.megaads.vn/api/staff/time-keeping/overtime";
        const DATA_URL = "https://raw.githubusercontent.com/thuangeminipro-byte/phapsuchuongmy/refs/heads/main/data.json";

        let staffs = [], locs = [], scheds = JSON.parse(localStorage.getItem('schedules')) || [];

        async function fetchCloudData() {
            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                const data = await res.json();
                staffs = data.staffs; locs = data.locs;
                renderStaffs(); updateLocs(); updateSchedLocs();
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--success);">● Đồng bộ Cloud thành công</span>`;
                log("Đã cập nhật dữ liệu mới nhất từ GitHub.");
            } catch (e) { 
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--danger);">● Lỗi kết nối GitHub</span>`;
                log("Lỗi: Không thể tải data.json.", "#ff5858"); 
            }
        }

        window.onload = () => { fetchCloudData(); renderSched(); startClock(); document.getElementById('staffSelect').onchange = updateLocs; document.getElementById('sStaff').onchange = updateSchedLocs; document.getElementById('locSelect').onchange = updateInfo; };

        function renderStaffs() {
            const h = staffs.map((s, i) => `<option value="${i}">${s.name} (#${s.id})</option>`).join('');
            document.getElementById('staffSelect').innerHTML = h; document.getElementById('sStaff').innerHTML = h;
        }

        function updateLocs() {
            const sIdx = document.getElementById('staffSelect').value;
            const s = staffs[sIdx]; if(!s) return;
            document.getElementById('locSelect').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join('');
            updateInfo();
        }

        function updateSchedLocs() {
            const sIdx = document.getElementById('sStaff').value;
            const s = staffs[sIdx]; if(!s) return;
            document.getElementById('sLoc').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join('');
        }

        function updateInfo() {
            const s = staffs[document.getElementById('staffSelect').value];
            if(s) { document.getElementById('lblIP').innerText = s.ip; document.getElementById('lblDevice').innerText = s.device; }
        }

        function addSched() {
            const t = document.getElementById('sTime').value; if(!t) return alert("Chọn giờ!");
            const sS = document.getElementById('sStaff'), lS = document.getElementById('sLoc');
            scheds.push({ id: Date.now(), time: t, type: document.getElementById('sType').value, sIdx: sS.value, sName: sS.options[sS.selectedIndex].text, lIdx: lS.value, lName: lS.options[lS.selectedIndex].text, exec: false, st: "ĐANG ĐỢI" });
            localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched();
        }

        function renderSched() {
            const b = document.getElementById('schedBody'); b.innerHTML = '';
            scheds.sort((a,b) => new Date(a.time) - new Date(b.time)).forEach(s => {
                const tr = document.createElement('tr'); if(s.exec) tr.style.opacity = "0.5";
                const badge = s.type == 'OT' ? 'badge-ot' : 'badge-office';
                tr.innerHTML = `<td>${new Date(s.time).toLocaleString('vi-VN')}</td><td><span class="${badge}">${s.type}</span></td><td>${s.sName}</td><td>${s.lName}</td><td>${s.st}</td><td style="text-align:right"><button class="btn-del-item" onclick="delS(${s.id})">XÓA</button></td>`;
                b.appendChild(tr);
            });
        }

        window.delS = (id) => { if(confirm("Xóa lịch?")) { scheds = scheds.filter(x => x.id != id); localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }};

        function startClock() {
            setInterval(() => {
                const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN');
                scheds.forEach(s => {
                    if(!s.exec) {
                        const diff = now - new Date(s.time);
                        if(diff >= 0 && diff < 60000) { trigger(s.type, staffs[s.sIdx], locs[s.lIdx]); s.exec = true; s.st = "XONG"; localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }
                        else if (diff >= 60000) { s.exec = true; s.st = "BỎ QUA"; localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }
                    }
                });
            }, 2000);
        }

        async function trigger(type, st, lc) {
            log(`Gửi lệnh [${type}] cho ${st.name}...`);
            try {
                const res = await fetch(type == 'OT' ? API_OT : API_OFFICE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ staff_id: st.id, location_data: { lat: lc.lat, long: lc.lng, ip: st.ip, location_name: lc.name } }) });
                const d = await res.json(); log(`[${res.status}] ${d.message || 'Thành công'}`);
            } catch (e) { log("Lỗi: Kiểm tra Allow CORS!", "#ff5858"); }
        }

        function manual(t) { trigger(t, staffs[document.getElementById('staffSelect').value], locs[document.getElementById('locSelect').value]); }
        function log(m, c = "var(--success)") { const d = document.createElement('div'); d.style.color = (c=="var(--success)" ? "var(--success)" : c); d.innerText = `> ${new Date().toLocaleTimeString()} ${m}`; document.getElementById('logs').prepend(d); }
    </script>
</body>
</html>
