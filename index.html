<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megaads v52 - Mobile Ready</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00f2fe; --secondary: #4facfe; --accent-ot: #fa709a; --accent-ot-end: #fee140; --success: #43e97b; --danger: #ff5858; --text: #e0e6ed; --border: rgba(0, 242, 254, 0.2); }
        body { 
            margin: 0; padding: 15px; font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top, #1e1b4b, #0f0c29, #050517);
            color: var(--text); display: grid; grid-template-columns: 360px 1fr; gap: 20px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }
        /* Responsive: Chuyển sang 1 cột trên điện thoại */
        @media (max-width: 900px) {
            body { grid-template-columns: 1fr; overflow-y: auto; height: auto; }
            .sidebar, .main-content { overflow-y: visible; }
        }

        .card { 
            background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 18px; 
            border: 1px solid var(--border); backdrop-filter: blur(10px); position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        h2 { 
            margin: 0 0 15px 0; font-family: 'Orbitron', sans-serif; font-size: 12px; 
            text-transform: uppercase; color: var(--primary); letter-spacing: 2px; 
            text-shadow: 0 0 8px rgba(0, 242, 254, 0.5);
        }
        
        select, input { 
            width: 100%; padding: 14px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); 
            color: #fff; border-radius: 12px; font-size: 14px; margin-bottom: 12px; outline: none;
            transition: 0.3s; box-sizing: border-box; color-scheme: dark;
        }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 12px var(--primary); }

        /* Tách xa các nút chấm công */
        .btn-row { display: flex; gap: 15px; margin-top: 5px; }
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 11px; 
            color: white; text-transform: uppercase; letter-spacing: 1px;
        }
        button:active { transform: scale(0.96); }
        .btn-office { background: linear-gradient(135deg, var(--secondary), var(--primary)); box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3); }
        .btn-ot { background: linear-gradient(135deg, var(--accent-ot), var(--accent-ot-end)); box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3); }
        
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; }
        .badge-office { border: 1px solid var(--primary); color: var(--primary); }
        .badge-ot { background: linear-gradient(90deg, var(--accent-ot), var(--accent-ot-end)); color: #000; }

        .table-container { overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { padding: 12px; text-align: left; font-size: 10px; color: var(--primary); background: rgba(0,0,0,0.3); }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        
        #clock { float: right; font-size: 18px; color: var(--primary); font-family: 'Orbitron', sans-serif; }
        #logs { background: rgba(0,0,0,0.4); color: var(--success); font-family: monospace; padding: 15px; border-radius: 12px; flex: 1; overflow-y: auto; border: 1px solid var(--border); font-size: 12px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card">
            <h2>NHÂN VIÊN</h2>
            <select id="staffSelect"></select>
            <label style="font-size: 10px; color: var(--primary); margin-bottom: 5px; display: block;">ĐỊA ĐIỂM HỢP LỆ</label>
            <select id="locSelect"></select>
            <div style="font-size: 11px; line-height: 1.6; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                IP: <span id="lblIP" style="color:var(--primary)">...</span><br>
                DEVICE: <span id="lblDevice" style="color:var(--primary)">...</span>
            </div>
        </div>
        <div class="card">
            <h2>GỬI LỆNH NHANH</h2>
            <div class="btn-row"> <button onclick="manual('HÀNH CHÍNH')" class="btn-office">HÀNH CHÍNH</button>
                <button onclick="manual('OT')" class="btn-ot">TĂNG CA</button>
            </div>
        </div>
        <div class="card">
            <h2>CLOUD SYNC</h2>
            <div id="syncStat" style="font-size: 11px; margin-bottom: 10px;">Đang kết nối...</div>
            <button onclick="fetchCloudData()" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border);">LÀM MỚI DATA</button>
        </div>
    </div>
    <div class="main-content">
        <div class="card" style="display:flex; flex-direction:column; max-height:55%;">
            <h2>HẸN GIỜ <span id="clock">00:00:00</span></h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px;">
                <div><label style="font-size:9px;">THỜI GIAN</label><input type="datetime-local" id="sTime"></div>
                <div><label style="font-size:9px;">LOẠI</label><select id="sType"><option value="HÀNH CHÍNH">HÀNH CHÍNH</option><option value="OT">OT</option></select></div>
                <div><label style="font-size:9px;">NHÂN VIÊN</label><select id="sStaff"></select></div>
                <div><label style="font-size:9px;">ĐỊA ĐIỂM</label><select id="sLoc"></select></div>
                <button onclick="confirmAndAdd()" style="background:linear-gradient(90deg, #8E2DE2, #4A00E0); height:48px; margin-top:14px;">XÁC NHẬN LỊCH</button>
            </div>
            <div class="table-container">
                <table><thead><tr><th>GIỜ</th><th>LOẠI</th><th>TÊN</th><th>ĐỊA ĐIỂM</th><th>ST</th><th></th></tr></thead><tbody id="schedBody"></tbody></table>
            </div>
        </div>
        <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <h2>HỆ THỐNG TERMINAL</h2>
            <div id="logs">> Megaads v52 sẵn sàng...</div>
        </div>
    </div>

    <script>
        const API_OFFICE = "https://hrm-api.megaads.vn/api/staff/send-finger-print";
        const API_OT = "https://hrm-api.megaads.vn/api/staff/time-keeping/overtime";
        const DATA_URL = "https://raw.githubusercontent.com/thuangeminipro-byte/phapsuchuongmy/refs/heads/main/data.json";

        let staffs = [], locs = [], scheds = JSON.parse(localStorage.getItem('schedules')) || [];

        async function fetchCloudData() {
            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                const data = await res.json();
                staffs = data.staffs; locs = data.locs;
                renderStaffs(); updateLocs(); updateSchedLocs();
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--success);">● Cloud: ${new Date().toLocaleTimeString()}</span>`;
            } catch (e) { log("Lỗi tải data!", "#ff5858"); }
        }

        window.onload = () => { fetchCloudData(); renderSched(); startClock(); document.getElementById('staffSelect').onchange = updateLocs; document.getElementById('sStaff').onchange = updateSchedLocs; document.getElementById('locSelect').onchange = updateInfo; };

        function renderStaffs() { const h = staffs.map((s, i) => `<option value="${i}">${s.name}</option>`).join(''); document.getElementById('staffSelect').innerHTML = h; document.getElementById('sStaff').innerHTML = h; }
        function updateLocs() { const s = staffs[document.getElementById('staffSelect').value]; if(!s) return; document.getElementById('locSelect').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join(''); updateInfo(); }
        function updateSchedLocs() { const s = staffs[document.getElementById('sStaff').value]; if(!s) return; document.getElementById('sLoc').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join(''); }
        function updateInfo() { const s = staffs[document.getElementById('staffSelect').value]; if(s) { document.getElementById('lblIP').innerText = s.ip; document.getElementById('lblDevice').innerText = s.device; }}

        function confirmAndAdd() {
            const t = document.getElementById('sTime').value;
            if(!t) return alert("Chọn giờ!");
            if(confirm(`Hẹn giờ cho ${document.getElementById('sStaff').selectedOptions[0].text}?`)) {
                const sS = document.getElementById('sStaff'), lS = document.getElementById('sLoc');
                scheds.push({ id: Date.now(), time: t, type: document.getElementById('sType').value, sIdx: sS.value, sName: sS.options[sS.selectedIndex].text, lIdx: lS.value, lName: lS.options[lS.selectedIndex].text, exec: false, st: "CHỜ" });
                localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched();
            }
        }

        function renderSched() {
            const b = document.getElementById('schedBody'); b.innerHTML = '';
            scheds.sort((a,b) => new Date(a.time) - new Date(b.time)).forEach(s => {
                const tr = document.createElement('tr'); if(s.exec) tr.style.opacity = "0.4";
                const badge = s.type == 'OT' ? 'badge-ot' : 'badge-office';
                tr.innerHTML = `<td>${new Date(s.time).toLocaleString('vi-VN')}</td><td><span class="${badge}">${s.type}</span></td><td>${s.sName}</td><td>${s.lName}</td><td>${s.st}</td><td style="text-align:right"><button onclick="delS(${s.id})" style="background:rgba(255,88,88,0.2); color:var(--danger); width:auto; padding:5px 10px;">X</button></td>`;
                b.appendChild(tr);
            });
        }

        window.delS = (id) => { if(confirm("Xóa?")) { scheds = scheds.filter(x => x.id != id); localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }};

        function startClock() {
            setInterval(() => {
                const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN');
                scheds.forEach(s => {
                    if(!s.exec) {
                        const diff = now - new Date(s.time);
                        if(diff >= 0 && diff < 60000) { trigger(s.type, staffs[s.sIdx], locs[s.lIdx]); s.exec = true; s.st = "XONG"; localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }
                    }
                });
            }, 2000);
        }

        async function trigger(type, st, lc) {
            log(`Gửi lệnh [${type}] cho ${st.name}...`);
            try {
                const res = await fetch(type == 'OT' ? API_OT : API_OFFICE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ staff_id: st.id, location_data: { lat: lc.lat, long: lc.lng, ip: st.ip, location_name: lc.name } }) });
                const d = await res.json(); log(`[Xong] ${d.message || 'Thành công'}`);
            } catch (e) { log("Lỗi CORS!", "#ff5858"); }
        }

        function manual(t) { trigger(t, staffs[document.getElementById('staffSelect').value], locs[document.getElementById('locSelect').value]); }
        function log(m, c = "var(--success)") { const d = document.createElement('div'); d.style.color = (c=="var(--success)" ? "var(--success)" : c); d.innerText = `> ${new Date().toLocaleTimeString()}: ${m}`; document.getElementById('logs').prepend(d); }
    </script>
</body>
</html>
