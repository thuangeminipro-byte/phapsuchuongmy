<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megaads Cloud v53 - GPS Enhanced</title>
    <style>
        :root { --primary: #00f2fe; --secondary: #4facfe; --accent-ot: #fa709a; --accent-ot-end: #fee140; --success: #43e97b; --danger: #ff5858; --text: #e0e6ed; --border: rgba(0, 242, 254, 0.2); }
        
        body { 
            margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; 
            background: radial-gradient(circle at top, #1e1b4b, #0f0c29, #050517);
            color: var(--text); display: grid; grid-template-columns: 360px 1fr; gap: 25px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }

        @media (max-width: 1000px) {
            body { grid-template-columns: 1fr; overflow-y: auto; height: auto; }
            .sidebar, .main-content { overflow-y: visible; height: auto; }
        }

        .card { 
            background: rgba(255, 255, 255, 0.03); padding: 22px; border-radius: 18px; 
            border: 1px solid var(--border); backdrop-filter: blur(12px); position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 18px 18px 0 0; }
        
        h2 { margin: 0 0 18px 0; font-size: 13px; text-transform: uppercase; color: var(--primary); letter-spacing: 2px; font-weight: 700; }
        label { font-size: 10px; color: var(--primary); margin-bottom: 6px; display: block; font-weight: 600; opacity: 0.8; }
        
        select, input { 
            width: 100%; padding: 13px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--border); 
            color: #fff; border-radius: 10px; font-size: 14px; margin-bottom: 12px; outline: none; transition: 0.3s; color-scheme: dark;
        }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 242, 254, 0.3); }

        /* Căn chỉnh các nút không bị lệch */
        .btn-row { display: flex; gap: 18px; margin-top: 5px; align-items: center; }
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 11px; color: white; text-transform: uppercase;
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-office { background: linear-gradient(135deg, var(--secondary), var(--primary)); }
        .btn-ot { background: linear-gradient(135deg, var(--accent-ot), var(--accent-ot-end)); }
        
        .badge { padding: 5px 12px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-office { border: 1px solid var(--primary); color: var(--primary); box-shadow: inset 0 0 5px var(--primary); }
        .badge-ot { background: linear-gradient(90deg, var(--accent-ot), var(--accent-ot-end)); color: #000; }

        .table-container { overflow-x: auto; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { padding: 15px; text-align: left; font-size: 11px; color: var(--primary); background: rgba(0,0,0,0.4); text-transform: uppercase; position: sticky; top: 0; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }

        /* Khung GPS & Info */
        .info-box { font-family: 'Consolas', monospace; font-size: 11px; line-height: 1.8; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; border: 1px dashed var(--border); }
        .info-box span { color: var(--primary); font-weight: bold; float: right; }
        
        #clock { float: right; font-size: 20px; color: var(--primary); font-weight: bold; text-shadow: 0 0 10px var(--primary); }
        #logs { background: rgba(0,0,0,0.5); color: var(--success); font-family: 'Consolas', monospace; padding: 20px; border-radius: 15px; flex: 1; overflow-y: auto; border: 1px solid var(--border); font-size: 12px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card">
            <h2>HỒ SƠ NHÂN VIÊN</h2>
            <select id="staffSelect"></select>
            <label>ĐỊA ĐIỂM CHẤM CÔNG</label>
            <select id="locSelect"></select>
            <div class="info-box">
                IP MẠNG: <span id="lblIP">...</span><br>
                THIẾT BỊ: <span id="lblDevice">...</span><br>
                VĨ ĐỘ (LAT): <span id="lblLat">...</span><br>
                KINH ĐỘ (LNG): <span id="lblLng">...</span>
            </div>
        </div>
        <div class="card">
            <h2>GỬI LỆNH TRỰC TIẾP</h2>
            <div class="btn-row">
                <button onclick="manual('HÀNH CHÍNH')" class="btn-office">HÀNH CHÍNH</button>
                <button onclick="manual('OT')" class="btn-ot">TĂNG CA</button>
            </div>
        </div>
        <div class="card">
            <h2>ĐỒNG BỘ DỮ LIỆU</h2>
            <div id="syncStat" style="font-size: 11px; margin-bottom: 12px;">Đang kết nối Cloud...</div>
            <button onclick="fetchCloudData()" style="background: rgba(0,242,254,0.1); border: 1px solid var(--primary); color: var(--primary);">LÀM MỚI DỮ LIỆU</button>
        </div>
    </div>
    <div class="main-content">
        <div class="card" style="display:flex; flex-direction:column; max-height:55%;">
            <h2>BẢNG HẸN GIỜ <span id="clock">00:00:00</span></h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; background:rgba(0,0,0,0.4); padding:18px; border-radius:15px; align-items: center;">
                <div><label>THỜI GIAN</label><input type="datetime-local" id="sTime"></div>
                <div><label>CHẾ ĐỘ</label><select id="sType" style="margin-bottom:0;"><option value="HÀNH CHÍNH">HÀNH CHÍNH</option><option value="OT">OT</option></select></div>
                <div><label>NHÂN VIÊN</label><select id="sStaff" style="margin-bottom:0;"></select></div>
                <div><label>ĐỊA ĐIỂM</label><select id="sLoc" style="margin-bottom:0;"></select></div>
                <button onclick="confirmAndAdd()" style="background:linear-gradient(90deg, #8E2DE2, #4A00E0); height:48px; box-shadow: 0 4px 15px rgba(142, 45, 226, 0.4);">THÊM LỊCH</button>
            </div>
            <div class="table-container">
                <table><thead><tr><th>GIỜ HẸN</th><th>LOẠI</th><th>NHÂN VIÊN</th><th>ĐỊA ĐIỂM</th><th>GPS (LAT, LNG)</th><th>TRẠNG THÁI</th><th></th></tr></thead><tbody id="schedBody"></tbody></table>
            </div>
        </div>
        <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <h2>NHẬT KÝ HỆ THỐNG</h2>
            <div id="logs">> Megaads v53 ready. GPS tracking enabled.</div>
        </div>
    </div>

    <script>
        const API_OFFICE = "https://hrm-api.megaads.vn/api/staff/send-finger-print";
        const API_OT = "https://hrm-api.megaads.vn/api/staff/time-keeping/overtime";
        const DATA_URL = "https://raw.githubusercontent.com/thuangeminipro-byte/phapsuchuongmy/refs/heads/main/data.json";

        let staffs = [], locs = [], scheds = JSON.parse(localStorage.getItem('schedules')) || [];

        async function fetchCloudData() {
            try {
                const res = await fetch(DATA_URL + "?t=" + Date.now());
                const data = await res.json();
                staffs = data.staffs; locs = data.locs;
                renderStaffs(); updateLocs(); updateSchedLocs();
                document.getElementById('syncStat').innerHTML = `<span style="color:var(--success);">● Cloud: ${new Date().toLocaleTimeString()}</span>`;
            } catch (e) { log("Lỗi đồng bộ dữ liệu!", "#ff5858"); }
        }

        window.onload = () => { fetchCloudData(); renderSched(); startClock(); document.getElementById('staffSelect').onchange = updateLocs; document.getElementById('sStaff').onchange = updateSchedLocs; document.getElementById('locSelect').onchange = updateInfo; };

        function renderStaffs() { const h = staffs.map((s, i) => `<option value="${i}">${s.name}</option>`).join(''); document.getElementById('staffSelect').innerHTML = h; document.getElementById('sStaff').innerHTML = h; }
        
        function updateLocs() { 
            const s = staffs[document.getElementById('staffSelect').value]; if(!s) return; 
            document.getElementById('locSelect').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join(''); 
            updateInfo(); 
        }

        function updateSchedLocs() { 
            const s = staffs[document.getElementById('sStaff').value]; if(!s) return; 
            document.getElementById('sLoc').innerHTML = locs.filter(l => l.owner == "all" || l.owner == s.id).map((l, i) => `<option value="${i}">${l.name}</option>`).join(''); 
        }

        function updateInfo() { 
            const s = staffs[document.getElementById('staffSelect').value]; 
            const l = locs[document.getElementById('locSelect').value];
            if(s) { document.getElementById('lblIP').innerText = s.ip; document.getElementById('lblDevice').innerText = s.device; }
            if(l) { document.getElementById('lblLat').innerText = l.lat; document.getElementById('lblLng').innerText = l.lng; }
        }

        function confirmAndAdd() {
            const t = document.getElementById('sTime').value;
            if(!t) return alert("Hệ thống yêu cầu nhập thời gian!");
            const sS = document.getElementById('sStaff'), lS = document.getElementById('sLoc');
            const locObj = locs[lS.value];
            if(confirm(`Xác nhận đặt lịch cho ${sS.options[sS.selectedIndex].text}?`)) {
                scheds.push({ id: Date.now(), time: t, type: document.getElementById('sType').value, sIdx: sS.value, sName: sS.options[sS.selectedIndex].text, lIdx: lS.value, lName: lS.options[lS.selectedIndex].text, lat: locObj.lat, lng: locObj.lng, exec: false, st: "CHỜ" });
                localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched();
            }
        }

        function renderSched() {
            const b = document.getElementById('schedBody'); b.innerHTML = '';
            scheds.sort((a,b) => new Date(a.time) - new Date(b.time)).forEach(s => {
                const tr = document.createElement('tr'); if(s.exec) tr.style.opacity = "0.4";
                const badge = s.type == 'OT' ? 'badge-ot' : 'badge-office';
                tr.innerHTML = `<td>${new Date(s.time).toLocaleString('vi-VN')}</td><td><span class="${badge}">${s.type}</span></td><td>${s.sName}</td><td>${s.lName}</td><td style="color:var(--primary); font-family:monospace;">${s.lat}, ${s.lng}</td><td>${s.st}</td><td style="text-align:right"><button onclick="delS(${s.id})" style="background:rgba(255,88,88,0.2); color:var(--danger); width:auto; padding:5px 12px; border:1px solid var(--danger);">X</button></td>`;
                b.appendChild(tr);
            });
        }

        window.delS = (id) => { if(confirm("Xóa lịch?")) { scheds = scheds.filter(x => x.id != id); localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }};

        function startClock() {
            setInterval(() => {
                const now = new Date(); document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN');
                scheds.forEach(s => {
                    if(!s.exec) {
                        const diff = now - new Date(s.time);
                        if(diff >= 0 && diff < 60000) { trigger(s.type, staffs[s.sIdx], locs[s.lIdx]); s.exec = true; s.st = "XONG"; localStorage.setItem('schedules', JSON.stringify(scheds)); renderSched(); }
                    }
                });
            }, 2000);
        }

        async function trigger(type, st, lc) {
            log(`Gửi lệnh [${type}] cho ${st.name} tại GPS: ${lc.lat}, ${lc.lng}...`);
            try {
                const res = await fetch(type == 'OT' ? API_OT : API_OFFICE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ staff_id: st.id, location_data: { lat: lc.lat, long: lc.lng, ip: st.ip, location_name: lc.name } }) });
                const d = await res.json(); log(`[Xong] ${d.message || 'Thành công'}`);
            } catch (e) { log("Lỗi CORS!", "#ff5858"); }
        }

        function manual(t) { trigger(t, staffs[document.getElementById('staffSelect').value], locs[document.getElementById('locSelect').value]); }
        function log(m, c = "var(--success)") { const d = document.createElement('div'); d.style.color = (c=="var(--success)" ? "var(--success)" : c); d.innerText = `> ${new Date().toLocaleTimeString()}: ${m}`; document.getElementById('logs').prepend(d); }
    </script>
</body>
</html>
